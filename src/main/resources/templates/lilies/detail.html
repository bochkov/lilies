{% extends 'lilies/index' %}

{% block title %}{{ object.name }} - {% endblock %}

{% block content %}
<div class="row">
    <div class="medium-2 columns text-right">
        <dl class="dl">
            {% if object.composer.size > 0 %}
            <dt>Композитор</dt>
            {% for composer in object.composer %}<dd>{{ composer.str }}</dd>{% endfor %}
            {% endif %}

            {% if object.writer.size > 0 %}
            <dt>Слова</dt>
            {% for writer in object.writer %}<dd>{{ writer.str }}</dd>{% endfor %}
            {% endif %}

            {% if object.instrument.size > 0 %}
            <dt>Инструмент</dt>
            {% for inst in object.instrument %}<dd>{{ inst.str }}</dd>{% endfor %}
            {% endif %}

            <dt>Сложность</dt><dd>{{ object.difficulty.rating|stars|raw }}</dd>
        </dl>
        <ul class="stack button-group">
            {% if object.hasMp3 %}
            <li>
                <a class="button small audio-control">
                    <audio src="/media/{{ object.mp3Filename }}" id="sheet-{{ object.id }}" type="audio/mpeg" preload="none"></audio>
                    <i class="fa fa-music"></i> Слушать</a>
            </li>
            {% endif %}
            {% if object.hasPdf %}
            <li>
                <a class="button small" target="_blank" href="/media/{{ object.pdfFilename }}">
                    <i class="fa fa-save"></i> PDF</a>
            </li>
            {% endif %}
            {% if object.hasSrc %}
            <li>
                <a class="button small" target="_blank" href="/media/{{ object.srcFilename }}">
                    <i class="fa fa-file"></i> .ly файл</a>
            </li>
            {% endif %}
        </ul>
    </div>
    <canvas class="columns medium-10" id="pdf-canvas"></canvas>
</div>

<div class="row">
    <div class="medium-12 columns pagination-centered">
        <ul class="pagination" role="menubar">
            <li class="arrow unavailable" id="pdf-prev">
                <a href="#" onclick="goPrev();">&laquo; Предыдущая страница</a>
            </li>
            <li class="arrow unavailable" id="pdf-next">
                <a href="#" onclick="goNext()">Следующая страница &raquo;</a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script type="text/javascript" src="/static/js/pdf.js"></script>
<script type="text/javascript" src="/static/js/compatibility.js"></script>
<script type="text/javascript">
    PDFJS.workerSrc = '/static/js/pdf.worker.js';
    PDFJS.disableWorker = true;
    var pdfdoc = null,
            pageNum = 1,
            canvas = document.getElementById("pdf-canvas"),
            ctx = canvas.getContext("2d");

    function renderPage(num){
        pdfdoc.getPage(num).then(function(page) {
            var scale = 1025 / page.getViewport(1.0).width;
            var viewport = page.getViewport(scale);
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            var renderContext = { canvasContext: ctx, viewport: viewport };
            page.render(renderContext);

            var next = $("#pdf-next"), prev = $("#pdf-prev");
            prev.removeClass("unavailable");
            next.removeClass("unavailable");
            if (num == pdfdoc.numPages) { next.addClass("unavailable"); }
            if (num == 1) { prev.addClass("unavailable"); }
        });
    }

    function goPrev(){
        if (pageNum <= 1) return;
        --pageNum;
        renderPage(pageNum);
    }

    function goNext(){
        if (pageNum >= pdfdoc.numPages) return;
        ++pageNum;
        renderPage(pageNum);
    }

    PDFJS.getDocument("/media/{{ object.pdfFilename }}").then(function(_pdfdoc){
        pdfdoc = _pdfdoc;
        renderPage(pageNum);
    });

    function audio_play(object){
        var i = object.children("i");

        var id = object.children("audio").attr("id");
        var audio = document.getElementById(id);
        audio.addEventListener("ended", function(){
            i.removeClass("fa-pause").addClass("fa-music");
        });

        if (audio.paused) {
            i.removeClass("fa-music").addClass("fa-pause");
            audio.play();
        }
        else {
            i.removeClass("fa-pause").addClass("fa-music");
            audio.pause();
            audio.currentTime = 0;
        }
    }

    $(function(){
        $(".audio-control").click(function(){ audio_play($(this)); });
        $(document).keypress(function(event){ if (event.which == 112) audio_play($(".audio-control")); })
    });

    $(document).keyup(function(event){
        if (event.keyCode == 37) goPrev();
        if (event.keyCode == 39) goNext();
    });
</script>
{% endblock %}